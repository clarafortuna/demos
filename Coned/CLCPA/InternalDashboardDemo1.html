<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CLCPA DAC Dashboard (2024)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root{
      --bg:#f0f4f8; --card:#ffffff; --border:#e2e8f0; --text:#0f172a; --muted:#64748b;
      --good:#10b981; --warn:#f59e0b; --bad:#f43f5e; --dac:#0f172a; --non:#cbd5e1; --accent:#334155;
      --good-bg:#ecfdf5; --warn-bg:#fffbeb; --bad-bg:#fff1f2;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',ui-sans-serif,system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}

    .wrap{max-width:1280px;margin:0 auto;padding:28px 24px}

    /* Password gate */
    .gate{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      background:rgba(15,23,42,.55);
      backdrop-filter:saturate(120%) blur(6px);
      padding:24px;
    }
    .gate-card{
      width:min(420px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(15,23,42,.18);
      padding:18px;
    }
    .gate-title{
      font-size:14px; font-weight:800; letter-spacing:-0.01em; color:var(--text);
      margin-bottom:6px;
    }
    .gate-sub{
      font-size:12.5px; color:var(--muted); margin-bottom:14px;
    }
    .gate-row{
      display:flex; gap:8px; align-items:center;
    }
    .gate-input{
      flex:1;
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0 12px;
      font-size:13px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    .gate-input:focus{
      border-color:#cbd5e1;
      box-shadow:0 0 0 3px rgba(15,23,42,.06);
    }
    .gate-btn{
      height:40px;
      border-radius:12px;
      border:1px solid var(--text);
      background:var(--text);
      color:#fff;
      padding:0 14px;
      font-weight:700;
      font-size:12.5px;
      cursor:pointer;
    }
    .gate-btn:hover{opacity:.95}
    .gate-err{
      margin-top:10px;
      font-size:12px;
      color:var(--bad);
      font-weight:600;
      display:none;
    }

    /* Header */
    .header{background:var(--card);border-radius:20px;border:1px solid var(--border);padding:24px 28px;margin-bottom:20px;box-shadow:0 1px 3px rgba(15,23,42,.06);display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .header-left{}
    .kicker{font-size:11px;color:var(--muted);font-weight:700;letter-spacing:.08em;text-transform:uppercase}
    h1{margin:4px 0 0;font-size:22px;font-weight:800;letter-spacing:-0.02em;color:var(--text)}
    .sub{margin-top:5px;color:var(--muted);font-size:12.5px;font-weight:400}
    .pillset{display:flex;gap:6px;align-items:center}
    .pill-label{font-size:11px;color:var(--muted);font-weight:600;margin-right:4px}
    .pill{border:1px solid var(--border);background:#f8fafc;border-radius:999px;padding:7px 14px;font-weight:600;font-size:12px;cursor:pointer;transition:all .15s;color:var(--muted)}
    .pill:hover{background:#f1f5f9;color:var(--text)}
    .pill.active{background:var(--text);color:#fff;border-color:var(--text);box-shadow:0 2px 6px rgba(15,23,42,.2)}

    /* Tabs */
    .tabs-wrap{background:var(--card);border-radius:16px;border:1px solid var(--border);padding:12px 16px;margin-bottom:20px;box-shadow:0 1px 3px rgba(15,23,42,.04)}
    .tabs{display:flex;flex-wrap:wrap;gap:6px}
    .tab{border:1px solid transparent;background:transparent;border-radius:999px;padding:6px 14px;font-weight:600;font-size:12px;cursor:pointer;transition:all .15s;color:var(--muted);font-family:inherit}
    .tab:hover{background:#f1f5f9;color:var(--text)}
    .tab.active{background:var(--text);color:#fff;border-color:var(--text);box-shadow:0 2px 6px rgba(15,23,42,.15)}

    /* KPI Grid */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:16px}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 1px 3px rgba(15,23,42,.05);transition:box-shadow .2s}
    .card:hover{box-shadow:0 4px 12px rgba(15,23,42,.08)}
    .cardhead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .title{font-size:12px;color:var(--muted);font-weight:600;line-height:1.4}
    .big{margin-top:6px;font-size:28px;font-weight:800;letter-spacing:-0.02em;color:var(--text)}
    .status{margin-top:3px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:4px}
    .status::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;display:inline-block}
    .bench{font-size:11px;color:var(--muted);text-align:right;font-weight:500;white-space:nowrap}
    .bench b{display:block;color:var(--text);font-size:15px;font-weight:700;margin-top:2px}
    .bench span{font-size:10.5px}
    .meta{margin-top:14px;background:#f8fafc;border-radius:12px;padding:12px;border:1px solid #f1f5f9}
    .meta-row{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:3px 0}
    .meta-row:not(:last-child){border-bottom:1px solid #f1f5f9}
    .meta-row .lbl{font-size:11px;color:var(--muted);font-weight:500}
    .meta-row .val{font-size:12px;color:var(--text);font-weight:700}
    .note{margin-top:8px;font-size:10.5px;color:var(--muted);font-weight:400;font-style:italic}

    /* Panels */
    .panel{margin-top:16px}
    .panelcard{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 1px 3px rgba(15,23,42,.05)}
    .panel h2{font-size:14px;font-weight:700;color:var(--text)}
    .panel p{margin:4px 0 0;font-size:12px;color:var(--muted);font-weight:400}
    .panelbody{margin-top:14px}

    /* Legend */
    .legend{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
    .legitem{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--muted);font-weight:500}
    .swatch{width:10px;height:10px;border-radius:3px;flex-shrink:0}
    .swatch.good{background:var(--good)} .swatch.warn{background:var(--warn)} .swatch.bad{background:var(--bad)}
    .swatch.dac{background:var(--dac)} .swatch.non{background:var(--non)}
    .swatch.floor{background:#0f172a} .swatch.target{background:var(--accent)}

    /* Table */
    .table-wrap{overflow-x:auto;margin-top:4px}
    table.styled{width:100%;border-collapse:collapse}
    table.styled thead th{font-size:11px;color:var(--muted);text-align:left;padding:8px 12px;font-weight:600;border-bottom:2px solid var(--border);white-space:nowrap}
    table.styled tbody tr{transition:background .1s}
    table.styled tbody tr:hover{background:#f8fafc}
    table.styled tbody td{padding:10px 12px;font-size:12.5px;color:var(--text);font-weight:500;border-bottom:1px solid #f1f5f9}
    table.styled tbody td:first-child{font-weight:600}

    /* Notes footer */
    .notes-footer{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px 22px;margin-top:20px;box-shadow:0 1px 3px rgba(15,23,42,.04)}
    .notes-footer h3{font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px}
    .notes-footer p{font-size:12px;color:var(--muted);font-weight:400}

    svg text{font-family:'Inter',ui-sans-serif,sans-serif}
  </style>
</head>
<body>

<!-- Password Gate -->
<div id="gate" class="gate" aria-hidden="false">
  <div class="gate-card" role="dialog" aria-modal="true" aria-label="Enter password">
    <div class="gate-title">Protected demo</div>
    <div class="gate-sub">Enter the password to view this page.</div>
    <div class="gate-row">
      <input id="gatePw" class="gate-input" type="password" autocomplete="current-password" placeholder="Password" />
      <button id="gateBtn" class="gate-btn" type="button">Enter</button>
    </div>
    <div id="gateErr" class="gate-err">Incorrect password.</div>
  </div>
</div>

<div class="wrap" id="protectedContent" style="display:none">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="kicker">Con Edison · CLCPA Reporting</div>
      <h1>DAC Dashboard (2024)</h1>
      <div class="sub">All tabs · 2024 values from the DAC report · 2025 points are illustrative placeholders</div>
    </div>
    <div class="pillset">
      <span class="pill-label">Benchmark</span>
      <button id="btn35" class="pill">35% Floor</button>
      <button id="btn40" class="pill active">40% Target</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-wrap">
    <div id="tabs" class="tabs"></div>
  </div>

  <div id="content"></div>

  <div class="notes-footer">
    <h3>Notes</h3>
    <p>Offline version uses inline SVG (no external scripts). In production, replace static numbers with a governed data mart/API and add tract-level GIS layers.</p>
  </div>

</div>

<script>
  // Password gate (client-side)
  (function(){
    const PASS = "dacdemo";
    const KEY = "clara_demo_auth_v1";

    const gate = document.getElementById("gate");
    const content = document.getElementById("protectedContent");
    const input = document.getElementById("gatePw");
    const btn = document.getElementById("gateBtn");
    const err = document.getElementById("gateErr");

    function unlock(){
      gate.style.display = "none";
      gate.setAttribute("aria-hidden","true");
      content.style.display = "";
    }

    function lock(){
      gate.style.display = "";
      gate.setAttribute("aria-hidden","false");
      content.style.display = "none";
    }

    function tryAuth(){
      const val = (input.value || "").trim();
      if(val === PASS){
        sessionStorage.setItem(KEY, "1");
        err.style.display = "none";
        unlock();
      }else{
        err.style.display = "block";
        input.focus();
        input.select();
      }
    }

    if(sessionStorage.getItem(KEY) === "1"){
      unlock();
    }else{
      lock();
      setTimeout(()=>input.focus(), 50);
    }

    btn.addEventListener("click", tryAuth);
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") tryAuth();
    });
  })();
</script>

<script>
  const floor = 0.35;
  let target = 0.40;

  function fmtMoney(n){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(Number(n||0))}
  function fmtCompact(n){return new Intl.NumberFormat("en-US",{notation:"compact",maximumFractionDigits:2}).format(Number(n||0))}
  function fmtPct(x){return(x*100).toFixed(1)+"%"}

  function classify(s){
    if(s>=target) return {label:"Above target",color:"var(--good)",bgColor:"var(--good-bg)"};
    if(s>=floor)  return {label:"At threshold",color:"var(--warn)",bgColor:"var(--warn-bg)"};
    return {label:"Below floor",color:"var(--bad)",bgColor:"var(--bad-bg)"};
  }

  function trendFromShare(v,plus=0.03){
    return[{year:2023,share:Math.max(0,v-0.05)},{year:2024,share:v},{year:2025,share:Math.min(1,v+plus)}];
  }

  const DATA={
    executive:[
      {key:"Clean Energy Spend",share:0.54,meta:{unit:"usd",dac:204785586,total:380265714,note:"NENY incentives (2024)"}},
      {key:"EV Infrastructure",share:0.40,meta:{unit:"usd",dac:18281828,total:42799629,note:"Make-Ready incentive spend (2024)"}},
      {key:"Demand Response MW",share:0.40,meta:{unit:"MW",dac:303.07,total:766.94,note:"Delivered MW (avg event reductions)"}},
      {key:"DER MW Installed",share:0.354,meta:{unit:"MW",dac:64.62,total:182.54,note:"DER MW installed (2024)"}},
      {key:"Capital Impact",share:0.50,meta:{unit:"usd",dac:976591848*0.50,total:976591848,note:"Strategic electric capital (DAC impact est.)"}},
      {key:"Methane Reduction",share:0.52,meta:{unit:"mT CH4",dac:125.19,total:241.22,note:"Methane reductions"}},
      {key:"Affordability (EAP)",share:0.66,meta:{unit:"usd",dac:162532290+28964404,total:(162532290+28964404)+(95845105+22786170),note:"EAP discounts (electric+gas)"}},
      {key:"Workforce",share:0.59,meta:{unit:"placements",dac:87,total:123,note:"Academy placements (full-time vs total)"}},
    ],
    cleanEnergy:{
      kpis:[
        {key:"Spend in DACs",share:0.54,meta:{unit:"usd",dac:204785586,total:380265714,note:"Incentives"}},
        {key:"Savings in DACs",share:0.57,meta:{unit:"MMBtu",dac:2486965,total:4360879,note:"Energy savings"}},
        {key:"Participants in DACs",share:0.54,meta:{unit:"participants",dac:1130930,total:2087688,note:"Participants"}},
        {key:"Installations in DACs",share:0.51,meta:{unit:"installations",dac:152685,total:298607,note:"Installations"}},
      ],
      trend:trendFromShare(0.54,0.02),
      table:[
        {program:"AMEEP",dac:71602722,total:77558050,unit:"usd"},
        {program:"Res ASHP",dac:45204005,total:94920742,unit:"usd"},
        {program:"MF ASHP",dac:27928074,total:42663626,unit:"usd"},
      ]
    },
    ev:{
      kpis:[
        {key:"Incentive spend in DACs",share:0.43,meta:{unit:"usd",dac:18281828,total:42799629,note:"Make-Ready spend"}},
        {key:"Plugs in DACs",share:0.40,meta:{unit:"plugs",dac:1850,total:4312,note:"L2+DCFC"}},
      ],
      plugTypes:[{type:"L2",dac:1732,non:2386},{type:"DCFC",dac:118,non:76}],
      trend:trendFromShare(0.40,0.04),
    },
    dr:{
      kpis:[
        {key:"Participants in DACs",share:0.32,meta:{unit:"participants",dac:32919,total:104025,note:"Enrollments"}},
        {key:"Delivered MW in DACs",share:0.40,meta:{unit:"MW",dac:303.07,total:766.94,note:"Delivered MW"}},
      ],
      programs:[
        {prog:"CSRP",dacDelivered:134.64,delivered:326.68},
        {prog:"DLRP",dacDelivered:148.70,delivered:374.05},
        {prog:"BYOT",dacDelivered:3.77,delivered:21.09},
      ],
      trend:trendFromShare(0.40,0.03),
    },
    der:{
      kpis:[
        {key:"Projects in DACs",share:0.34,meta:{unit:"projects",dac:3584,total:10555,note:"2024 installs"}},
        {key:"MW installed in DACs",share:0.354,meta:{unit:"MW",dac:64.62,total:182.54,note:"2024 installs"}},
        {key:"CDG/RC subscribers in DACs",share:0.563,meta:{unit:"subscribers",dac:843,total:1498,note:"2024"}},
      ],
      netMetering:[
        {k:"NM projects (DAC)",v:3545},
        {k:"NM projects (Low-income)",v:752},
        {k:"NM MW (DAC)",v:25.82},
      ],
      trend:trendFromShare(0.354,0.025),
    },
    capital:{
      kpis:[
        {key:"Environmental",share:0.53,meta:{unit:"usd",dac:70779794*0.53,total:70779794,note:"DAC impact %"}},
        {key:"Risk Reduction",share:0.52,meta:{unit:"usd",dac:514647065*0.52,total:514647065,note:"DAC impact %"}},
        {key:"Safety & Security",share:0.54,meta:{unit:"usd",dac:24106971*0.54,total:24106971,note:"DAC impact %"}},
        {key:"System Expansion",share:0.46,meta:{unit:"usd",dac:367058018*0.46,total:367058018,note:"DAC impact %"}},
      ],
      chart:[{cat:"Environmental",dacPct:0.53},{cat:"Risk",dacPct:0.52},{cat:"Safety",dacPct:0.54},{cat:"Expansion",dacPct:0.46}],
      trend:trendFromShare(0.50,0.02),
    },
    reliability:{
      kpis:[
        {key:"Meter base in DACs",share:0.44,meta:{unit:"meters",dac:1677754,total:3820017,note:"Meter base"}},
        {key:"Interruptions in DACs",share:0.3428,meta:{unit:"interruptions",dac:164715,total:480464,note:"Customers interrupted"}},
      ],
      borough:[
        {geo:"Bronx",share:416963/(416963+44302)},
        {geo:"Brooklyn",share:386484/(386484+607622)},
        {geo:"Manhattan",share:263679/(263679+518622)},
        {geo:"Queens",share:364609/(364609+632000)},
        {geo:"Staten Island",share:50429/(50429+134986)},
        {geo:"Westchester",share:195590/(195590+204731)},
      ],
      trend:trendFromShare(0.3428,0.01),
    },
    gas:{
      kpis:[
        {key:"Leak-prone pipe miles in DACs",share:36/78,meta:{unit:"miles",dac:36,total:78,note:"LPP replaced"}},
        {key:"Methane reduction in DACs",share:125.19/241.22,meta:{unit:"mT CH4",dac:125.19,total:241.22,note:"Methane"}},
        {key:"Leaks repaired in DACs",share:3198/8302,meta:{unit:"repairs",dac:3198,total:8302,note:"Leak repairs"}},
      ],
      trend:trendFromShare(125.19/241.22,0.02),
    },
    affordability:{
      kpis:[
        {key:"EAP share in DACs",share:0.66,meta:{unit:"percent",dac:0.66,total:1,note:"EAP accounts"}},
        {key:"EAP discount dollars in DACs",share:(162532290+28964404)/((162532290+28964404)+(95845105+22786170)),meta:{unit:"usd",dac:162532290+28964404,total:(162532290+28964404)+(95845105+22786170),note:"Discount dollars"}},
      ],
      usage:[
        {label:"Electric (kWh)",dac:5455330732,non:8331039856},
        {label:"Gas (ccf)",dac:264936296,non:381682391},
      ],
      arrears:[
        {k:"60–90 days (accts)",v:312470},
        {k:"60–90 days ($)",v:55040891},
        {k:"90+ days (accts)",v:264398},
        {k:"90+ days ($)",v:563924629},
      ],
      trend:trendFromShare(0.66,0.01),
    },
    workforce:{
      kpis:[
        {key:"Enrolled",share:null,meta:{unit:"people",dac:390,total:390,note:"Academy enrolled"}},
        {key:"Graduates",share:null,meta:{unit:"people",dac:290,total:290,note:"Academy graduates"}},
        {key:"Placed (full-time)",share:null,meta:{unit:"people",dac:87,total:87,note:"Full-time placements"}},
        {key:"Hire share from DACs",share:0.59,meta:{unit:"percent",dac:0.59,total:1,note:"DAC share"}},
      ],
      pipeline:[
        {label:"Enrolled",dac:390,non:0},
        {label:"Graduates",dac:290,non:0},
        {label:"Placed FT",dac:87,non:0},
        {label:"Placed Total",dac:123,non:0},
      ],
      trend:trendFromShare(0.59,0.03),
    },
    boroughMap:{
      rows:[
        {geo:"Bronx",share:416963/(416963+44302)},
        {geo:"Brooklyn",share:386484/(386484+607622)},
        {geo:"Manhattan",share:263679/(263679+518622)},
        {geo:"Queens",share:364609/(364609+632000)},
        {geo:"Staten Island",share:50429/(50429+134986)},
        {geo:"Westchester",share:195590/(195590+204731)},
      ]
    }
  };

  function renderKPICards(list){
    const grid=document.createElement('div');
    grid.className='grid';
    list.forEach(k=>{
      const hasShare=k.share!=null;
      const c=hasShare?classify(k.share):{label:"",color:"var(--muted)",bgColor:"#f8fafc"};
      const metaShare=k.meta&&k.meta.total?(k.meta.dac/k.meta.total):null;
      const unit=k.meta?.unit;
      const dacVal=unit==='usd'?fmtMoney(k.meta.dac):unit==='percent'?fmtPct(k.meta.dac):fmtCompact(k.meta.dac)+" "+unit;
      const totalVal=unit==='usd'?fmtMoney(k.meta.total):unit==='percent'?"100%":fmtCompact(k.meta.total)+" "+unit;

      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`
        <div class="cardhead">
          <div style="flex:1;min-width:0">
            <div class="title">${k.key}</div>
            <div class="big">${hasShare?fmtPct(k.share):dacVal}</div>
            ${hasShare?`<div class="status" style="color:${c.color}">${c.label}</div>`:''}
          </div>
          <div class="bench">
            <span style="font-size:10px;font-weight:600;color:var(--muted)">Benchmark</span>
            <b>${fmtPct(target)}</b>
            <span>Floor ${fmtPct(floor)}</span>
          </div>
        </div>
        <div class="meta">
          <div class="meta-row"><span class="lbl">DAC</span><span class="val">${dacVal}</span></div>
          <div class="meta-row"><span class="lbl">Total</span><span class="val">${totalVal}</span></div>
          ${metaShare!=null&&hasShare?`<div class="meta-row"><span class="lbl">DAC share</span><span class="val" style="color:${c.color}">${fmtPct(metaShare)}</span></div>`:''}
          ${k.meta?.note?`<div class="note">${k.meta.note}</div>`:''}
        </div>
      `;
      grid.appendChild(card);
    });
    return grid;
  }

  function mkPanel(title,desc){
    const el=document.createElement('div');
    el.className='panel';
    el.innerHTML=`<div class="panelcard"><h2>${title}</h2>${desc?`<p>${desc}</p>`:''}<div class="panelbody"></div></div>`;
    return{el,body:el.querySelector('.panelbody')};
  }

  function mkLegend(includeBench=false){
    const div=document.createElement('div');
    div.className='legend';
    div.innerHTML=`
      <div class="legitem"><span class="swatch dac"></span>DAC</div>
      <div class="legitem"><span class="swatch non"></span>Non-DAC</div>
      <div class="legitem"><span class="swatch good"></span>Above target</div>
      <div class="legitem"><span class="swatch warn"></span>At threshold</div>
      <div class="legitem"><span class="swatch bad"></span>Below floor</div>
      ${includeBench?`<div class="legitem"><span class="swatch floor"></span>Floor 35%</div><div class="legitem"><span class="swatch target"></span>Target ${Math.round(target*100)}%</div>`:''}
    `;
    return div;
  }

  function svgBarComparisons(items,opts={}){
    const W=opts.W||1080,H=opts.H||300,padL=56,padR=24,padT=28,padB=56;
    const iW=W-padL-padR,iH=H-padT-padB;
    const maxY=opts.maxY||0.80;
    const xStep=iW/items.length;
    const barW=Math.min(80,xStep*0.55);
    const yv=v=>padT+iH*(1-(v/maxY));
    const hv=v=>iH*(v/maxY);
    const ticks=[0,0.2,0.4,0.6,0.8].filter(t=>t<=maxY+0.01);
    const floorY=yv(floor),targetY=yv(target);

    const grid=ticks.map(t=>`
      <line x1="${padL}" y1="${yv(t)}" x2="${W-padR}" y2="${yv(t)}" stroke="#e2e8f0" stroke-width="1"/>
      <text x="${padL-8}" y="${yv(t)+4}" text-anchor="end" font-size="11" fill="#94a3b8" font-weight="500">${Math.round(t*100)}%</text>
    `).join('');

    const bars=items.map((it,i)=>{
      const cx=padL+xStep*i+xStep/2,bx=cx-barW/2;
      const by=yv(it.share),bh=hv(it.share);
      const c=classify(it.share);
      const colorMap={'var(--good)':'#10b981','var(--warn)':'#f59e0b','var(--bad)':'#f43f5e'};
      const fill=colorMap[c.color]||c.color;
      const gid=`g${i}`;
      return `
        <defs>
          <linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="${fill}" stop-opacity="1"/>
            <stop offset="100%" stop-color="${fill}" stop-opacity="0.7"/>
          </linearGradient>
        </defs>
        <g>
          <rect x="${bx}" y="${by}" width="${barW}" height="${bh}" rx="8" fill="url(#${gid})"/>
          <text x="${cx}" y="${by-7}" text-anchor="middle" font-size="11" fill="#0f172a" font-weight="700">${fmtPct(it.share)}</text>
          <text x="${cx}" y="${H-padB+18}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="500">${it.label}</text>
        </g>
      `;
    }).join('');

    return`<svg width="100%" viewBox="0 0 ${W} ${H}">
      ${grid}
      <line x1="${padL}" y1="${floorY}" x2="${W-padR}" y2="${floorY}" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="5 4"/>
      <text x="${W-padR-4}" y="${floorY-6}" text-anchor="end" font-size="11" fill="#64748b" font-weight="600">Floor 35%</text>
      <line x1="${padL}" y1="${targetY}" x2="${W-padR}" y2="${targetY}" stroke="#0f172a" stroke-width="1.5" stroke-dasharray="2 5"/>
      <text x="${W-padR-4}" y="${targetY-6}" text-anchor="end" font-size="11" fill="#0f172a" font-weight="600">Target ${Math.round(target*100)}%</text>
      ${bars}
    </svg>`;
  }

  function svgTrend(points,opts={}){
    const W=opts.W||1080,H=opts.H||240,padL=56,padR=24,padT=28,padB=40;
    const iW=W-padL-padR,iH=H-padT-padB;
    const maxY=opts.maxY||0.80;
    const xv=i=>padL+iW*i/(points.length-1);
    const yv=v=>padT+iH*(1-(v/maxY));
    const floorY=yv(floor),targetY=yv(target);
    const path=points.map((p,i)=>`${i===0?'M':'L'} ${xv(i)} ${yv(p.share)}`).join(' ');
    const area=`${path} L ${xv(points.length-1)} ${padT+iH} L ${xv(0)} ${padT+iH} Z`;
    const ticks=[0,0.2,0.4,0.6,0.8].filter(t=>t<=maxY+0.01);
    const grid=ticks.map(t=>`
      <line x1="${padL}" y1="${yv(t)}" x2="${W-padR}" y2="${yv(t)}" stroke="#e2e8f0" stroke-width="1"/>
      <text x="${padL-8}" y="${yv(t)+4}" text-anchor="end" font-size="11" fill="#94a3b8" font-weight="500">${Math.round(t*100)}%</text>
    `).join('');
    const dots=points.map((p,i)=>`
      <g>
        <circle cx="${xv(i)}" cy="${yv(p.share)}" r="5" fill="#fff" stroke="#0f172a" stroke-width="2.5"/>
        <text x="${xv(i)}" y="${yv(p.share)-12}" text-anchor="middle" font-size="11" fill="#0f172a" font-weight="700">${fmtPct(p.share)}</text>
        <text x="${xv(i)}" y="${H-padB+16}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="500">${p.year}</text>
      </g>
    `).join('');

    return`<svg width="100%" viewBox="0 0 ${W} ${H}">
      <defs>
        <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="#0f172a" stop-opacity="0.12"/>
          <stop offset="100%" stop-color="#0f172a" stop-opacity="0.01"/>
        </linearGradient>
      </defs>
      ${grid}
      <path d="${area}" fill="url(#areaGrad)"/>
      <line x1="${padL}" y1="${floorY}" x2="${W-padR}" y2="${floorY}" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="5 4"/>
      <text x="${W-padR-4}" y="${floorY-6}" text-anchor="end" font-size="11" fill="#64748b" font-weight="600">Floor 35%</text>
      <line x1="${padL}" y1="${targetY}" x2="${W-padR}" y2="${targetY}" stroke="#0f172a" stroke-width="1.5" stroke-dasharray="2 5"/>
      <text x="${W-padR-4}" y="${targetY-6}" text-anchor="end" font-size="11" fill="#0f172a" font-weight="600">Target ${Math.round(target*100)}%</text>
      <path d="${path}" fill="none" stroke="#0f172a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      ${dots}
    </svg>`;
  }

  function svgStackedBars(items,opts={}){
    const W=opts.W||1080,H=opts.H||280,padL=70,padR=24,padT=28,padB=56;
    const iW=W-padL-padR,iH=H-padT-padB;
    const maxY=opts.maxY||Math.max(...items.map(d=>d.dac+d.non))*1.2;
    const xStep=iW/items.length;
    const barW=Math.min(100,xStep*0.55);
    const yv=v=>padT+iH*(1-(v/maxY));
    const hv=v=>iH*(v/maxY);
    const ticks=[0,maxY*0.25,maxY*0.5,maxY*0.75];
    const grid=ticks.map(t=>`
      <line x1="${padL}" y1="${yv(t)}" x2="${W-padR}" y2="${yv(t)}" stroke="#e2e8f0" stroke-width="1"/>
      <text x="${padL-8}" y="${yv(t)+4}" text-anchor="end" font-size="11" fill="#94a3b8" font-weight="500">${fmtCompact(t)}</text>
    `).join('');

    const bars=items.map((d,i)=>{
      const cx=padL+xStep*i+xStep/2,bx=cx-barW/2;
      const total=d.non+d.dac,topY=yv(total),nonH=hv(d.non),dacH=hv(d.dac),dacY=yv(d.dac);
      return`<g>
        <rect x="${bx}" y="${topY}" width="${barW}" height="${nonH}" rx="0" fill="#cbd5e1"/>
        <rect x="${bx}" y="${dacY}" width="${barW}" height="${dacH}" rx="0" fill="#0f172a"/>
        <rect x="${bx}" y="${topY}" width="${barW}" height="8" rx="6" fill="${d.non>0?'#cbd5e1':'#0f172a'}"/>
        <rect x="${bx}" y="${dacY+dacH-8}" width="${barW}" height="8" rx="6" fill="#0f172a"/>
        <text x="${cx}" y="${H-padB+18}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="500">${d.label}</text>
      </g>`;
    }).join('');

    return`<svg width="100%" viewBox="0 0 ${W} ${H}">${grid}${bars}</svg>`;
  }

  function renderTable(headers,rows){
    const wrap=document.createElement('div');
    wrap.className='table-wrap';
    const t=document.createElement('table');
    t.className='styled';
    t.innerHTML=`<thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
    wrap.appendChild(t);
    return wrap;
  }

  // ---------- Pages ----------
  function pageExecutive(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.executive));
    const p1=mkPanel('DAC Impact Across Domains','Comparison across domains vs CLCPA floor/target.');
    p1.body.innerHTML=svgBarComparisons(DATA.executive.map(d=>({label:d.key.replace(' (EAP)',''),share:d.share})),{maxY:0.80});
    p1.body.appendChild(mkLegend(true));
    w.appendChild(p1.el);
    const p2=mkPanel('Trajectory vs CLCPA Benchmarks','Illustrative trend for Clean Energy DAC share (2023–2025).');
    p2.body.innerHTML=svgTrend(DATA.cleanEnergy.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageCleanEnergy(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.cleanEnergy.kpis));
    const p1=mkPanel('Spend share trend','2023–2025 (2025 illustrative placeholder).');
    p1.body.innerHTML=svgTrend(DATA.cleanEnergy.trend,{maxY:0.80});
    w.appendChild(p1.el);
    const p2=mkPanel('Top programs (spend context)','A few programs for illustration; expand in production.');
    p2.body.appendChild(renderTable(['Program','DAC','Total'],DATA.cleanEnergy.table.map(r=>[r.program,fmtMoney(r.dac),fmtMoney(r.total)])));
    w.appendChild(p2.el);
    return w;
  }

  function pageEV(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.ev.kpis));
    const p1=mkPanel('Plugs by type (stacked)','DAC vs Non-DAC for L2 and DCFC.');
    p1.body.innerHTML=svgStackedBars(DATA.ev.plugTypes.map(d=>({label:d.type,dac:d.dac,non:d.non})),{maxY:5000});
    p1.body.appendChild(mkLegend());
    w.appendChild(p1.el);
    const p2=mkPanel('DAC plug share trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.ev.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageDR(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.dr.kpis));
    const p1=mkPanel('Delivered MW by program','DAC delivered vs remainder (subset).');
    const items=DATA.dr.programs.map(p=>({label:p.prog,dac:p.dacDelivered,non:Math.max(0,p.delivered-p.dacDelivered)}));
    p1.body.innerHTML=svgStackedBars(items,{maxY:450});
    p1.body.appendChild(mkLegend());
    w.appendChild(p1.el);
    const p2=mkPanel('DAC share of delivered MW trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.dr.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageDER(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.der.kpis));
    const p1=mkPanel('Net Metering & Low-Income (2024)','Key values.');
    p1.body.appendChild(renderTable(['Metric','Value'],DATA.der.netMetering.map(r=>[r.k,fmtCompact(r.v)])));
    w.appendChild(p1.el);
    const p2=mkPanel('DAC share of DER MW trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.der.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageCapital(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.capital.kpis));
    const p1=mkPanel('Capital DAC impact by category','DAC % by category.');
    p1.body.innerHTML=svgBarComparisons(DATA.capital.chart.map(c=>({label:c.cat,share:c.dacPct})),{maxY:0.80});
    w.appendChild(p1.el);
    const p2=mkPanel('DAC-weighted capital impact trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.capital.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageReliability(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.reliability.kpis));
    const p1=mkPanel('Meter base DAC share by borough','Borough comparison.');
    p1.body.innerHTML=svgBarComparisons(DATA.reliability.borough.map(b=>({label:b.geo,share:b.share})),{maxY:1.0});
    w.appendChild(p1.el);
    const p2=mkPanel('DAC share of interruptions trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.reliability.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageGas(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.gas.kpis));
    const p1=mkPanel('Methane DAC share trend','2023–2025 (2025 illustrative placeholder).');
    p1.body.innerHTML=svgTrend(DATA.gas.trend,{maxY:0.80});
    w.appendChild(p1.el);
    return w;
  }

  function pageAffordability(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.affordability.kpis));
    const p1=mkPanel('Usage totals (stacked)','DAC vs Non-DAC consumption.');
    p1.body.innerHTML=svgStackedBars(DATA.affordability.usage,{maxY:10_000_000_000});
    p1.body.appendChild(mkLegend());
    w.appendChild(p1.el);
    const p2=mkPanel('Arrears (DAC)','Year-end exposure for DAC accounts and dollars.');
    p2.body.appendChild(renderTable(['Metric','Value'],DATA.affordability.arrears.map(r=>[r.k,r.k.includes('$')?fmtMoney(r.v):fmtCompact(r.v)])));
    w.appendChild(p2.el);
    const p3=mkPanel('EAP DAC share trend','2023–2025 (2025 illustrative placeholder).');
    p3.body.innerHTML=svgTrend(DATA.affordability.trend,{maxY:0.80});
    w.appendChild(p3.el);
    return w;
  }

  function pageWorkforce(){
    const w=document.createElement('div');
    w.appendChild(renderKPICards(DATA.workforce.kpis));
    const p1=mkPanel('Pipeline (counts)','Enrolled → Graduates → Placements.');
    p1.body.innerHTML=svgStackedBars(DATA.workforce.pipeline,{maxY:420});
    w.appendChild(p1.el);
    const p2=mkPanel('Hire share trend','2023–2025 (2025 illustrative placeholder).');
    p2.body.innerHTML=svgTrend(DATA.workforce.trend,{maxY:0.80});
    w.appendChild(p2.el);
    return w;
  }

  function pageBoroughMap(){
    const w=document.createElement('div');
    const p=mkPanel('Borough performance tiles','Color indicates status vs CLCPA benchmarks. Swap with real GIS shape map in production.');
    const rows=DATA.boroughMap.rows;
    const colorMap={'var(--good)':'#10b981','var(--warn)':'#f59e0b','var(--bad)':'#f43f5e'};
    const W=700,H=260;
    const svg=`<svg viewBox="0 0 ${W} ${H}" width="100%" style="max-width:700px">
      ${rows.map((b,i)=>{
        const c=classify(b.share);
        const fill=colorMap[c.color]||c.color;
        const col=i%3, row=Math.floor(i/3);
        const x=20+col*228, y=20+row*110;
        return`<g>
          <rect x="${x}" y="${y}" rx="16" ry="16" width="210" height="80" fill="${fill}" opacity="0.15"/>
          <rect x="${x}" y="${y}" rx="16" ry="16" width="210" height="80" fill="none" stroke="${fill}" stroke-width="2"/>
          <text x="${x+105}" y="${y+30}" text-anchor="middle" font-size="14" fill="#0f172a" font-weight="700">${b.geo}</text>
          <text x="${x+105}" y="${y+52}" text-anchor="middle" font-size="22" fill="${fill}" font-weight="800">${fmtPct(b.share)}</text>
          <text x="${x+105}" y="${y+70}" text-anchor="middle" font-size="11" fill="#64748b" font-weight="500">${c.label}</text>
        </g>`;
      }).join('')}
    </svg>`;
    p.body.innerHTML=svg;
    p.body.appendChild(mkLegend(true));
    w.appendChild(p.el);
    return w;
  }

  function pageNotes(){
    const w=document.createElement('div');
    const p=mkPanel('Notes','How to productionize this offline demo.');
    p.body.innerHTML=`<ul style="padding-left:18px;display:flex;flex-direction:column;gap:8px">
      <li style="font-size:12.5px;color:var(--muted);font-weight:400">2024 values are from the DAC report tables; 2025 values are illustrative placeholders.</li>
      <li style="font-size:12.5px;color:var(--muted);font-weight:400">In production, replace static values with a governed CLCPA reporting mart/API and add row-level security.</li>
      <li style="font-size:12.5px;color:var(--muted);font-weight:400">Replace borough tiles with a true GIS map (tracts, boroughs) and drilldown filters (year, program, community type).</li>
    </ul>`;
    w.appendChild(p.el);
    return w;
  }

  const pages={
    "Executive":pageExecutive,
    "Clean Energy":pageCleanEnergy,
    "EV":pageEV,
    "Demand Response":pageDR,
    "DER":pageDER,
    "Capital":pageCapital,
    "Reliability":pageReliability,
    "Gas":pageGas,
    "Affordability":pageAffordability,
    "Workforce":pageWorkforce,
    "Borough Map":pageBoroughMap,
    "Notes":pageNotes,
  };

  let currentTab="Executive";

  function renderTabs(){
    const tabWrap=document.getElementById('tabs');
    tabWrap.innerHTML='';
    Object.keys(pages).forEach(name=>{
      const b=document.createElement('button');
      b.className='tab'+(name===currentTab?' active':'');
      b.textContent=name;
      b.addEventListener('click',()=>{currentTab=name;render();});
      tabWrap.appendChild(b);
    });
  }

  function render(){
    renderTabs();
    const content=document.getElementById('content');
    content.innerHTML='';
    content.appendChild(pages[currentTab]());
  }

  function setBenchmark(mode){
    target=(mode==='35')?0.35:0.40;
    document.getElementById('btn35').classList.toggle('active',mode==='35');
    document.getElementById('btn40').classList.toggle('active',mode==='40');
    render();
  }

  document.getElementById('btn35').addEventListener('click',()=>setBenchmark('35'));
  document.getElementById('btn40').addEventListener('click',()=>setBenchmark('40'));

  render();
</script>
</body>
</html>
